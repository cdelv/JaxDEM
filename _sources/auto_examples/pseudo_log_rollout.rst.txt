
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/pseudo_log_rollout.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_pseudo_log_rollout.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_pseudo_log_rollout.py:


Pseudo-log trajectory rollout
----------------------------------------

This example demonstrates how to roll out dynamics while saving only a subset of
quantities at a pseudo-logarithmic set of step indices.

.. GENERATED FROM PYTHON SOURCE LINES 12-59

.. code-block:: Python


    import time
    import jax.numpy as jnp
    import jaxdem as jdem
    from jaxdem.utils.randomSphereConfiguration import random_sphere_configuration


    def build_microstate(
        *,
        n_particles: int,
        packing_fraction: float,
        space_dim: int,
        config_seed: int,
    ):
        mass = 1.0
        e_int = 1.0
        dt = 1e-2
        if space_dim == 2:
            cr = [0.5, 0.5]
            sr = [1.0, 1.4]
        else:
            cr = [1.0]
            sr = [1.0]
        particle_radii = jdem.utils.dispersity.get_polydisperse_radii(n_particles, cr, sr)
        pos, box_size = random_sphere_configuration(
            particle_radii, packing_fraction, space_dim, config_seed
        )
        microstate = jdem.State.create(
            pos=pos, rad=particle_radii, mass=jnp.ones(n_particles) * mass
        )
        mats = [jdem.Material.create("elastic", young=e_int, poisson=0.5, density=1.0)]
        matcher = jdem.MaterialMatchmaker.create("harmonic")
        mat_table = jdem.MaterialTable.from_materials(mats, matcher=matcher)
        microsystem = jdem.System.create(
            state_shape=microstate.shape,
            dt=dt,
            linear_integrator_type="verlet",
            rotation_integrator_type="",
            domain_type="periodic",
            force_model_type="spring",
            collider_type="naive",
            mat_table=mat_table,
            domain_kw=dict(box_size=box_size),
        )
        return microstate, microsystem









.. GENERATED FROM PYTHON SOURCE LINES 60-61

Setup

.. GENERATED FROM PYTHON SOURCE LINES 61-78

.. code-block:: Python


    N = 100
    phi = 0.7
    dim = 2
    seed = 0

    num_steps = 100_000
    reset_save_decade = 10_000
    min_save_decade = 100
    save_steps = jdem.utils.make_save_steps_pseudolog(
        num_steps=num_steps,
        reset_save_decade=reset_save_decade,
        min_save_decade=min_save_decade,
        decade=10,
        include_step0=True,
    )








.. GENERATED FROM PYTHON SOURCE LINES 79-80

Rollout

.. GENERATED FROM PYTHON SOURCE LINES 80-96

.. code-block:: Python


    st, sys = build_microstate(
        n_particles=N, packing_fraction=phi, space_dim=dim, config_seed=seed
    )
    save_steps_jax = jnp.asarray(save_steps)
    deltas = save_steps_jax[1:] - save_steps_jax[:-1]
    st, sys, (traj_state, _) = jdem.System.trajectory_rollout(
        st, sys, strides=deltas
    )
    pos_traj = traj_state.pos_c

    print("num saved frames:", pos_traj.shape[0])
    print("saved positions shape:", pos_traj.shape)
    print("final step:", int(sys.step_count))






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    num saved frames: 190
    saved positions shape: (190, 100, 2)
    final step: 100000




.. GENERATED FROM PYTHON SOURCE LINES 97-98

Speed comparison

.. GENERATED FROM PYTHON SOURCE LINES 98-143

.. code-block:: Python


    min_stride = int(jnp.min(save_steps_jax[1:] - save_steps_jax[:-1]))
    n_steps = int(save_steps[-1])

    state_w, system_w = build_microstate(
        n_particles=N, packing_fraction=phi, space_dim=dim, config_seed=seed
    )
    _, _, (traj_var_w, _) = jdem.System.trajectory_rollout(
        state_w, system_w, strides=deltas
    )
    traj_var_w.pos.block_until_ready()

    state_w, system_w = build_microstate(
        n_particles=N, packing_fraction=phi, space_dim=dim, config_seed=seed
    )
    _, _, (traj_w, _) = jdem.System.trajectory_rollout(
        state_w, system_w, n=n_steps // min_stride, stride=min_stride
    )
    traj_w.pos_c.block_until_ready()

    state_t, system_t = build_microstate(
        n_particles=N, packing_fraction=phi, space_dim=dim, config_seed=seed
    )
    t0 = time.perf_counter()
    _, _, (traj_var, _) = jdem.System.trajectory_rollout(
        state_t, system_t, strides=deltas
    )
    traj_var.pos.block_until_ready()
    t_var = time.perf_counter() - t0

    state_t, system_t = build_microstate(
        n_particles=N, packing_fraction=phi, space_dim=dim, config_seed=seed
    )
    t0 = time.perf_counter()
    _, _, (traj, _) = jdem.System.trajectory_rollout(
        state_t, system_t, n=n_steps // min_stride, stride=min_stride
    )
    traj.pos_c.block_until_ready()
    t_dense = time.perf_counter() - t0

    print("min stride:", min_stride)
    print("dense frames:", n_steps // min_stride)
    print("pseudo-log frames:", int(pos_traj.shape[0]))
    print("time pseudo-log (variable stride):", t_var)
    print("time dense trajectory_rollout:", t_dense)




.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    min stride: 100
    dense frames: 1000
    pseudo-log frames: 190
    time pseudo-log (variable stride): 4.811742797999955
    time dense trajectory_rollout: 4.81335421





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 24.862 seconds)


.. _sphx_glr_download_auto_examples_pseudo_log_rollout.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: pseudo_log_rollout.ipynb <pseudo_log_rollout.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: pseudo_log_rollout.py <pseudo_log_rollout.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: pseudo_log_rollout.zip <pseudo_log_rollout.zip>`
